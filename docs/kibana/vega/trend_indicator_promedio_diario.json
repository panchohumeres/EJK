# TREND INDICATOR - Total, comparando dos meses, para dos métricas (consumo diario promedio)


{
  "$schema": "https://vega.github.io/schema/vega/v3.0.json",
    config: {
    kibana: {
      renderer: svg
      }
  },
  "title": "",
  "data": [



    {
    "name": "values",
    "url": {
      "%context%": true,
      
      "index": "",
      "body": 

{"size": 0,

  "aggs": {

          "filters": {
            "terms" : { "field":"mes" },
            "aggs":{


  "sum_1": {
    "sum": {
      "field": "$$$$"
    }
  },
  "sum_2": 
{"cardinality" : {
            "field" : "dia_mes",
            "precision_threshold": 100
            }}


  ,
  "division": {
    "bucket_script": {
      "buckets_path": {
        "my_var1": "sum_1",
        "my_var2": "sum_2"
      },
      "script": "params.my_var1 / params.my_var2"
    }
  }
}
}
}
}




    },
    "format": {
      "property": "aggregations.filters.buckets"
    },
     "transform": [

        {
          "type": "window",
          "ops": ["row_number"],
          "as": ["row_number"]
        }
  ]},

{
      "name": "results",
      "values": [
        {}
      ],
      "transform": [
        {"type": "formula", "expr": "data('values')[0].division.value/1000", "as": "last"},
        {"type": "formula", "expr": "data('values')[1].division.value/1000", "as": "prev"},
        {"type": "formula", "expr": "datum.last>datum.prev", "as": "up"},
        {"type": "formula", "expr": "datum.last<datum.prev", "as": "down"},
        {
          "type": "formula",
          "expr": "if(datum.row_number==0, if(datum.prev==0,0,-1), (datum.last-datum.prev)/datum.last)",
          "as": "percentChange"
        },
        {
          "type": "formula",
          
          "expr": "if(datum.up,'',if(datum.down,'','🢝'))",
          "as": "symbol"
        }
      ]
    }
,




    {
    "name": "Mwh",
    "url": {
      "%context%": true,
      
      "index": "",
      "body": 


{"size": 0,

  "aggs": {

          "filters": {
            "terms" : { "field":"mes" },
            "aggs":{


  "sum_1": {
    "sum": {
      "field": "Kwh(ep1)"
    }
  },
  "sum_2": 
{"cardinality" : {
            "field" : "dia_mes",
            "precision_threshold": 100
            }}


  ,
  "division": {
    "bucket_script": {
      "buckets_path": {
        "my_var1": "sum_1",
        "my_var2": "sum_2"
      },
      "script": "params.my_var1 / params.my_var2"
    }
  }
}
}
}
}





    },
    "format": {
      "property": "aggregations.filters.buckets"
    },
     "transform": [

        {
          "type": "window",
          "ops": ["row_number"],
          "as": ["row_number"]
        }
  ]},

{
      "name": "results_mwh",
      "values": [
        {}
      ],
      "transform": [
        {"type": "formula", "expr": "data('Mwh')[0].division.value", "as": "last_mwh"},
        {"type": "formula", "expr": "data('Mwh')[1].division.value", "as": "prev_mwh"},
        {"type": "formula", "expr": "datum.last_mwh>datum.prev_mwh", "as": "up_mwh"},
        {"type": "formula", "expr": "datum.last_mwh<datum.prev_mwh", "as": "down_mwh"},
        {
          "type": "formula",
          "expr": "(datum.last_mwh-datum.prev_mwh)/datum.last_mwh",
          "as": "percentChange_mwh"
        },
        {
          "type": "formula",
          
          "expr": "if(datum.up_mwh,'',if(datum.down_mwh,'','🢝'))",
          "as": "symbol"
        }
      ]
    }


  ],

  
  "marks": [
    {
      "type": "text",

      "from": {"data": "results"},
      "encode": {
        "update": {

          "text": {
            "signal": "datum.symbol + ' ' + format(datum.last,'.2f') + ' K $CLP '+ ' ('+ format(datum.percentChange, '+.1%') + ')'"
          },

          "fill": {
            "signal": "if(datum.up, '#CA0000', if(datum.down, '#00ff00', '#00ff00'))"
          },

          "align": {"value": "middle"},
          "baseline": {"value": "bottom"},
          "xc": {"signal": "width/2"},
          "yc": {"signal": "height/2"},

          "fontSize": {"signal": "min(width/10, height)/1.3"}
        }
      }
    },
    
    
    {
      "type": "text",

      "from": {"data": "results_mwh"},
      "encode": {
        "update": {

          "text": {
            "signal": "datum.symbol + ' ' + format(datum.last_mwh,'.2f') +' KWh'+ ' ('+ format(datum.percentChange_mwh, '+.1%') + ')'"
          },

          "fill": {
            "signal": "if(datum.up_mwh, '#CA0000', if(datum.down_mwh, '#00ff00', '#00ff00'))"
          },

          "align": {"value": "middle"},
          "baseline": {"value": "top"},
          "xc": {"signal": "width/2"},
          "yc": {"signal": "height/2"},


          "fontSize": {"signal": "min(width/10, height)/1.3"}
        }
      }
    }    
    
    
    
    
    
  ]
}